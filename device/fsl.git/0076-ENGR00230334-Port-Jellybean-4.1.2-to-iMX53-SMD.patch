From ceb8c5bbcd836a37ea6f506686d2354312aa0136 Mon Sep 17 00:00:00 2001
From: Nitin Garg <nitin.garg@freescale.com>
Date: Thu, 18 Oct 2012 12:17:41 -0500
Subject: [PATCH 076/310] ENGR00230334: Port Jellybean 4.1.2 to iMX53 SMD

Add the iMX53 SMD support to the Jellybean branch

Change-Id: Ib367d7943e59df8c5400bdfa86b77edbb7fd5510
Signed-off-by: Nitin Garg <nitin.garg@freescale.com>
---
 imx53_smd/BoardConfig.mk                           |  63 +++--
 imx53_smd/fstab.freescale                          |  10 +
 imx53_smd/init.freescale.rc                        | 102 +++++++
 imx53_smd/init.rc                                  | 103 -------
 imx53_smd/init.usb.rc                              |  74 -----
 .../frameworks/base/core/res/res/values/config.xml |  12 +-
 imx5x/BoardConfigCommon.mk                         |  12 +-
 imx5x/apns-conf.xml                                | 301 +++++++++++++++++++++
 imx5x/build_id.mk                                  |   2 +-
 imx5x/imx53_smd.mk                                 |  18 +-
 imx5x/imx5x.mk                                     |  95 ++++---
 imx5x/init.freescale.usb.rc                        |  74 +++++
 imx5x/init.rc                                      |  89 ++----
 imx5x/ueventd.freescale.rc                         |  18 +-
 14 files changed, 642 insertions(+), 331 deletions(-)
 create mode 100644 imx53_smd/fstab.freescale
 create mode 100755 imx53_smd/init.freescale.rc
 delete mode 100755 imx53_smd/init.rc
 delete mode 100644 imx53_smd/init.usb.rc
 create mode 100644 imx5x/apns-conf.xml
 create mode 100644 imx5x/init.freescale.usb.rc

diff --git a/imx53_smd/BoardConfig.mk b/imx53_smd/BoardConfig.mk
index 54a2a2e..8d86757 100755
--- a/imx53_smd/BoardConfig.mk
+++ b/imx53_smd/BoardConfig.mk
@@ -8,30 +8,42 @@ TARGET_BOOTLOADER_BOARD_NAME := SMD
 
 BOARD_SOC_CLASS := IMX5X
 BOARD_SOC_TYPE := IMX53
-
-PRODUCT_MODEL := SMD-MX53
+PRODUCT_MODEL := IMX53-SMD
 
 # Wifi
-BOARD_WLAN_VENDOR := ATHEROS
-BOARD_WLAN_DEVICE := ar6003
-BOARD_HAS_ATH_WLAN := true
-BOARD_WLAN_ATHEROS_SDK := system/wlan/atheros/compat-wireless
-BOARD_WPA_SUPPLICANT_DRIVER := NL80211
-BOARD_HOSTAPD_DRIVER := NL80211
-WPA_SUPPLICANT_VERSION := VER_0_9_ATHEROS
-HOSTAPD_VERSION := VER_0_9_ATHEROS
-WIFI_DRIVER_MODULE_PATH         := "/system/lib/modules/ath6kl_sdio.ko"
-WIFI_DRIVER_MODULE_NAME         := "ath6kl_sdio"
-WIFI_DRIVER_MODULE_ARG          := "suspend_mode=2 ath6kl_p2p=1"
-WIFI_DRIVER_P2P_MODULE_ARG      := "suspend_mode=2 ath6kl_p2p=1 debug_mask=0x2413"
-WIFI_SDIO_IF_DRIVER_MODULE_PATH := "/system/lib/modules/cfg80211.ko"
-WIFI_SDIO_IF_DRIVER_MODULE_NAME := "cfg80211"
-WIFI_SDIO_IF_DRIVER_MODULE_ARG  := ""
-WIFI_COMPAT_MODULE_PATH  := "/system/lib/modules/compat.ko"
-WIFI_COMPAT_MODULE_NAME  := "compat"
-WIFI_COMPAT_MODULE_ARG   := ""
-WIFI_TEST_INTERFACE      := "sta"
-
+BOARD_WLAN_VENDOR			:= ATHEROS
+# for atheros vendor
+ifeq ($(BOARD_WLAN_VENDOR),ATHEROS)
+BOARD_WLAN_DEVICE			:= ar6003
+BOARD_HAS_ATH_WLAN 			:= true
+WPA_SUPPLICANT_VERSION			:= VER_0_8_ATHEROS
+WIFI_DRIVER_MODULE_PATH          	:= "/system/lib/modules/ath6kl_sdio.ko"
+WIFI_DRIVER_MODULE_NAME          	:= "ath6kl_sdio"
+WIFI_DRIVER_MODULE_ARG           	:= "suspend_mode=2 ar6k_clock=26000000 ath6kl_p2p=1"
+WIFI_DRIVER_P2P_MODULE_ARG       	:= "suspend_mode=2 ar6k_clock=26000000 ath6kl_p2p=1 debug_mask=0x2413"
+WIFI_SDIO_IF_DRIVER_MODULE_PATH  	:= "/system/lib/modules/cfg80211.ko"
+WIFI_SDIO_IF_DRIVER_MODULE_NAME  	:= "cfg80211"
+WIFI_SDIO_IF_DRIVER_MODULE_ARG   	:= ""
+WIFI_COMPAT_MODULE_PATH			:= "/system/lib/modules/compat.ko"
+WIFI_COMPAT_MODULE_NAME			:= "compat"
+WIFI_COMPAT_MODULE_ARG			:= ""
+endif
+#for intel vendor
+ifeq ($(BOARD_WLAN_VENDOR),INTEL)
+BOARD_HOSTAPD_PRIVATE_LIB		?= private_lib_driver_cmd
+BOARD_WPA_SUPPLICANT_PRIVATE_LIB 	?= private_lib_driver_cmd
+WPA_SUPPLICANT_VERSION			:= VER_0_7_X_INTEL
+HOSTAPD_VERSION				:= VER_0_7_X_INTEL
+WIFI_DRIVER_MODULE_PATH          	:= "/system/lib/modules/iwlagn.ko"
+WIFI_DRIVER_MODULE_NAME          	:= "iwlagn"
+WIFI_DRIVER_MODULE_PATH			?= auto
+endif
+BOARD_WPA_SUPPLICANT_DRIVER      	:= NL80211
+BOARD_HOSTAPD_DRIVER             	:= NL80211
+WIFI_TEST_INTERFACE			:= "sta"
+WIFI_DRIVER_FW_PATH_STA			:= "sta"
+WIFI_DRIVER_FW_PATH_AP			:= "ap"
+WIFI_DRIVER_FW_PATH_P2P			:= "p2p"
 
 BOARD_HAVE_VPU := true
 HAVE_FSL_IMX_GPU2D := true
@@ -50,16 +62,15 @@ SENSOR_MMA8451 := true
 # for recovery service
 TARGET_SELECT_KEY := 28
 TARGET_USERIMAGES_USE_EXT4 := true
-# we don't support sparse image.
-TARGET_USERIMAGES_SPARSE_EXT_DISABLED := true
 
 # atheros 3k BT
 BOARD_USE_AR3K_BLUETOOTH := true
 USE_OPENGL_RENDERER := true
+BOARD_EGL_CFG := device/fsl-proprietary/gpu/egl/egl.cfg
 
-BOARD_KERNEL_CMDLINE := console=ttymxc0,115200 init=/init androidboot.console=ttymxc0 video=mxcdi1fb:RGB666,LDB-XGA ldb=di1 di1_primary pmem=128M,64M fbmem=10M gpu_memory=128M vmalloc=576M fs_sdcard=1 androidboot.hardware=freescale 
+BOARD_KERNEL_CMDLINE := console=ttymxc0,115200 init=/init androidboot.console=ttymxc0 androidboot.hardware=freescale video=mxcfb0:dev=ldb,LDB-XGA,if=RGB666,bpp=32 video=mxcfb1:dev=sii902x_hdmi,1280x720M@60,bpp=32 ion=128M,64M fbmem=10M gpu_memory=128M vmalloc=576M
 
 BOARD_KERNEL_BASE := 0x70800000
 
-TARGET_BOOTLOADER_CONFIG := mx53_smd_android_ics_config
+TARGET_BOOTLOADER_CONFIG := mx53_smd_android_config
 
diff --git a/imx53_smd/fstab.freescale b/imx53_smd/fstab.freescale
new file mode 100644
index 0000000..92b6df2
--- /dev/null
+++ b/imx53_smd/fstab.freescale
@@ -0,0 +1,10 @@
+# Android fstab file.
+#<src>                                                  <mnt_point>         <type>    <mnt_flags>                                                                         <fs_mgr_flags>
+# The filesystem that contains the filesystem checker binary (typically /system) cannot
+# specify MF_CHECK, and must come before any filesystems that do specify MF_CHECK
+
+
+/dev/block/mmcblk0p2           /system             ext4      ro                                                    wait
+/dev/block/mmcblk0p6           /cache              ext4      noatime,nosuid,nodev,nomblk_io_submit,errors=panic    wait
+/dev/block/mmcblk0p5           /data               ext4      noatime,nosuid,nodev,nomblk_io_submit,errors=panic    wait
+
diff --git a/imx53_smd/init.freescale.rc b/imx53_smd/init.freescale.rc
new file mode 100755
index 0000000..fe61d74
--- /dev/null
+++ b/imx53_smd/init.freescale.rc
@@ -0,0 +1,102 @@
+import init.${ro.hardware}.usb.rc
+
+on boot
+
+    # Set permission for IIM node
+    symlink /dev/mxc_iim /dev/mxc_mem
+
+    # Enable Tethering in the Settings
+    setprop ro.tether.denied false
+
+    # Set GPS serial and reset GPIO pin
+    setprop ro.kernel.android.gps /dev/athrnmea
+    setprop persist.gps.oacmode @f
+    symlink /dev/ttymxc1 /dev/gpsdevice
+    write /sys/class/gpio/export 44
+    write /sys/class/gpio/gpio44/direction "out"
+    write /sys/class/gpio/gpio44/value 1
+
+    # Enable Tethering in the Settings
+    setprop ro.tether.denied false
+
+    # 3D acceleration property
+    setprop debug.sf.showfps    0
+    setprop debug.sf.hw         1
+    setprop ro.sf.lcd_density   160
+
+    # fsl omx graphic manager media framework property
+    setprop media.omxgm.enable-player 1
+    setprop media.omxgm.enable-record 1
+    setprop media.omxgm.enable-scan 1
+    setprop rw.VIDEO_RENDER_NAME video_render.surface
+
+    #Define the config for dual camera
+    #For landscape mode, orient is 0
+    #For portrait mode, orient is 90
+    #the android before honycomb are all in portrait mode
+    setprop front_camera_name ov
+    setprop front_camera_orient 0
+
+    # Set OpenGLES version
+    setprop ro.opengles.version 131072
+
+    # Enable auto configuration with 1, disable with 0
+    setprop ro.AUTO_CONFIG_DISPLAY  1
+
+    # Set rotation to 270 to cofigure as portrait mode
+    setprop ro.sf.hwrotation 0
+
+    # hdmi audio output
+    setprop ro.HDMI_AUDIO_OUTPUT 1
+
+    # Set light sensor sysfs path and light sensor threshold lux value
+    setprop ro.hardware.lightsensor "/sys/class/i2c-dev/i2c-2/device/2-0044/"
+    setprop ro.lightsensor.threshold  20
+
+    # Set mag3110 sensor sysfs path
+    setprop ro.hardware.magsensor "/sys/class/i2c-dev/i2c-1/device/1-000e/"
+
+    # Default backlight device
+    setprop hw.backlight.dev "pwm-backlight.0"
+    # Chmod/chown FSL specific sys entry
+    chown system system /sys/class/backlight/pwm-backlight.0/brightness
+    chmod 0660 /sys/class/backlight/pwm-backlight.0/brightness
+
+# Daemon processes to be run by init.
+service hciattach /system/bin/logwrapper /system/bin/hciattach -n -s 115200 /dev/ttymxc2 ath3k 3000000 flow sleep
+    user root
+    group bluetooth net_bt_admin
+    disabled
+    oneshot
+
+service p2p_supplicant /system/bin/wpa_supplicant \
+    -Dnl80211 -puse_p2p_group_interface=0  -e/data/misc/wifi/entropy.bin \
+    -iwlan0 -c/data/misc/wifi/wpa_supplicant.conf
+    class late_start
+    disabled
+    oneshot
+
+# magd daemon
+service magd /system/bin/magd
+    class main
+    user system
+    group input
+    oneshot
+
+# Orion InG
+service ing /system/etc/gps/ingsvcd -c /system/etc/gps/Orion.ini
+    socket athrkv9988    stream 666 system system
+    socket athrshmsocket stream 666 system system
+    socket athrsupl59991 stream 666 system system
+    class late_start
+    user root
+    group gps
+    oneshot
+
+service iprenew_wlan0 /system/bin/dhcpcd -n
+    class late_start
+    disabled
+    oneshot
+
+on fs
+    mount_all /fstab.freescale
diff --git a/imx53_smd/init.rc b/imx53_smd/init.rc
deleted file mode 100755
index 908f4ac..0000000
--- a/imx53_smd/init.rc
+++ /dev/null
@@ -1,103 +0,0 @@
-import init.${ro.hardware}.usb.rc
-
-on boot
-
-    # Set permission for IIM node
-    symlink /dev/mxc_iim /dev/mxc_mem
-
-    # Enable Tethering in the Settings
-    setprop ro.tether.denied false
-
-    # Set GPS serial and reset GPIO pin
-    setprop ro.kernel.android.gps /dev/athrnmea
-    setprop persist.gps.oacmode @f
-    symlink /dev/ttymxc1 /dev/gpsdevice
-    write /sys/class/gpio/export 44
-    write /sys/class/gpio/gpio44/direction "out"
-    write /sys/class/gpio/gpio44/value 1
-
-    # 3D acceleration property
-    setprop debug.sf.showfps    0
-    setprop debug.sf.hw         1
-    setprop debug.egl.hw	1
-    setprop ro.sf.lcd_density   160
-
-    # fsl omx graphic manager media framework property
-    setprop media.omxgm.enable-player 1
-    setprop media.omxgm.enable-record 1
-    setprop media.omxgm.enable-scan 1
-    setprop rw.VIDEO_RENDER_NAME video_render.surface
-
-    #Define the config for dual camera
-    #For landscape mode, orient is 0
-    #For portrait mode, orient is 90
-    #the android before honycomb are all in portrait mode
-    setprop front_camera_name ov
-    setprop front_camera_orient 0
-
-    # Set OpenGLES version
-    setprop ro.opengles.version 131072
-
-    # Enable auto configuration with 1, disable with 0
-    setprop ro.AUTO_CONFIG_DISPLAY  1
-
-    # Set rotation to 270 to cofigure as portrait mode
-    setprop ro.sf.hwrotation 0
-
-    # hdmi audio output
-    setprop ro.HDMI_AUDIO_OUTPUT 1
-
-    # Set light sensor sysfs path and light sensor threshold lux value
-    setprop ro.hardware.lightsensor "/sys/class/i2c-dev/i2c-2/device/2-0044/"
-    setprop ro.lightsensor.threshold  20
-
-    # Set mag3110 sensor sysfs path
-    setprop ro.hardware.magsensor "/sys/class/i2c-dev/i2c-1/device/1-000e/"
-
-    # Default backlight device
-    setprop hw.backlight.dev "pwm-backlight.0"
-    # Chmod/chown FSL specific sys entry
-    chown system system /sys/class/backlight/pwm-backlight.0/brightness
-    chmod 0660 /sys/class/backlight/pwm-backlight.0/brightness
-
-# Daemon processes to be run by init.
-service hciattach /system/bin/logwrapper /system/bin/hciattach -n -s 115200 /dev/ttymxc2 ath3k 3000000 flow sleep
-    user root
-    group bluetooth net_bt_admin
-    disabled
-    oneshot
-
-# magd daemon
-service magd /system/bin/magd
-    class main
-    user system
-    group input
-    oneshot
-
-# Orion InG
-service ing /system/etc/gps/ingsvcd -c /system/etc/gps/Orion.ini
-    socket athrkv9988    stream 666 system system
-    socket athrshmsocket stream 666 system system
-    socket athrsupl59991 stream 666 system system
-    class late_start
-    user root
-    group gps
-    oneshot
-
-service wpa_supplicant /system/bin/wpa_supplicant \
-    -Dnl80211 -puse_p2p_group_interface=0 -e/data/misc/wifi/entropy.bin
-    class late_start
-    disabled
-    oneshot
-
-service iprenew_wlan0 /system/bin/dhcpcd -n
-    class late_start
-    disabled
-    oneshot
-
-on fs
-# mount ext4 partitions
-    mount ext4 /dev/block/mmcblk0p2 /system
-    mount ext4 /dev/block/mmcblk0p2 /system ro remount
-    mount ext4 /dev/block/mmcblk0p5 /data nosuid nodev nodiratime noatime noauto_da_alloc
-    mount ext4 /dev/block/mmcblk0p6 /cache nosuid nodev
diff --git a/imx53_smd/init.usb.rc b/imx53_smd/init.usb.rc
deleted file mode 100644
index a9b832d..0000000
--- a/imx53_smd/init.usb.rc
+++ /dev/null
@@ -1,74 +0,0 @@
-# USB massstorage configuration, with adb
-on property:sys.usb.config=mass_storage,adb
-    write /sys/class/android_usb/android0/enable 0
-    write /sys/class/android_usb/android0/idVendor 18d1
-    write /sys/class/android_usb/android0/idProduct d02
-    write /sys/class/android_usb/android0/functions $sys.usb.config
-    write /sys/class/android_usb/android0/enable 1
-    start adbd
-    setprop sys.usb.state $sys.usb.config
-
-# USB massstorage configuration
-on property:sys.usb.config=mass_storage
-    write /sys/class/android_usb/android0/enable 0
-    write /sys/class/android_usb/android0/idVendor 18d1
-    write /sys/class/android_usb/android0/idProduct 2d01
-    write /sys/class/android_usb/android0/functions $sys.usb.config
-    write /sys/class/android_usb/android0/enable 1
-    setprop sys.usb.state $sys.usb.config
-
-# USB rndis configuration
-on property:sys.usb.config=rndis
-    write /sys/class/android_usb/android0/enable 0
-    write /sys/class/android_usb/android0/idVendor 18d1
-    write /sys/class/android_usb/android0/idProduct 4e23
-    write /sys/class/android_usb/android0/functions $sys.usb.config
-    write /sys/class/android_usb/android0/bDeviceClass 224
-    write /sys/class/android_usb/android0/enable 1
-    setprop sys.usb.state $sys.usb.config
-
-# USB rndis configuration with adb
-on property:sys.usb.config=rndis,adb
-    write /sys/class/android_usb/android0/enable 0
-    write /sys/class/android_usb/android0/idVendor 18d1
-    write /sys/class/android_usb/android0/idProduct 4e24
-    write /sys/class/android_usb/android0/functions $sys.usb.config
-    write /sys/class/android_usb/android0/bDeviceClass 224
-    write /sys/class/android_usb/android0/enable 1
-    start adbd
-    setprop sys.usb.state $sys.usb.config
-
-on property:sys.usb.config=mtp
-    write /sys/class/android_usb/android0/enable 0
-    write /sys/class/android_usb/android0/idVendor 18d1
-    write /sys/class/android_usb/android0/idProduct 2d02
-    write /sys/class/android_usb/android0/functions $sys.usb.config
-    write /sys/class/android_usb/android0/enable 1
-    setprop sys.usb.state $sys.usb.config
-
-on property:sys.usb.config=mtp,adb
-    write /sys/class/android_usb/android0/enable 0
-    write /sys/class/android_usb/android0/idVendor 18d1
-    write /sys/class/android_usb/android0/idProduct d02
-    write /sys/class/android_usb/android0/functions $sys.usb.config
-    write /sys/class/android_usb/android0/enable 1
-    start adbd
-    setprop sys.usb.state $sys.usb.config
-
-on property:sys.usb.config=ptp
-    write /sys/class/android_usb/android0/enable 0
-    write /sys/class/android_usb/android0/idVendor 18d1
-    write /sys/class/android_usb/android0/idProduct 2d03
-    write /sys/class/android_usb/android0/functions $sys.usb.config
-    write /sys/class/android_usb/android0/enable 1
-    setprop sys.usb.state $sys.usb.config
-
-on property:sys.usb.config=ptp,adb
-    write /sys/class/android_usb/android0/enable 0
-    write /sys/class/android_usb/android0/idVendor 18d1
-    write /sys/class/android_usb/android0/idProduct d02
-    write /sys/class/android_usb/android0/functions $sys.usb.config
-    write /sys/class/android_usb/android0/enable 1
-    start adbd
-    setprop sys.usb.state $sys.usb.config
-
diff --git a/imx53_smd/overlay/frameworks/base/core/res/res/values/config.xml b/imx53_smd/overlay/frameworks/base/core/res/res/values/config.xml
index 3ea5006..eea17b0 100755
--- a/imx53_smd/overlay/frameworks/base/core/res/res/values/config.xml
+++ b/imx53_smd/overlay/frameworks/base/core/res/res/values/config.xml
@@ -86,6 +86,12 @@
         <item>"ethernet,9,9,2,-1,true"</item>
     </string-array>
 
+    <!-- Package name providing network location support. -->
+    <string name="config_networkLocationProviderPackageName" translatable="false">com.google.android.location</string>
+
+    <!-- Package name providing geocoder API support. -->
+    <string name="config_geocodeProviderPackageName" translatable="false">com.google.android.location</string>
+
     <!-- Flag indicating whether we should enable the automatic brightness in Settings.
          config_hardware_automatic_brightness_available is not set, so we will use software implementation -->
     <bool name="config_automatic_brightness_available">true</bool>
@@ -166,10 +172,4 @@
          movement threshold where scrolling should begin. -->
     <dimen name="config_viewConfigurationTouchSlop">24dp</dimen>
 
-    <!-- Component name of the service providing network location support. -->
-    <string name="config_networkLocationProviderPackageName" translatable="false">com.google.android.location</string>
-
-    <!-- Component name of the service providing geocoder API support. -->
-    <string name="config_geocodeProviderPackageName" translatable="false">com.google.android.location</string>
-
 </resources>
diff --git a/imx5x/BoardConfigCommon.mk b/imx5x/BoardConfigCommon.mk
index ce74ecd..efaeb83 100755
--- a/imx5x/BoardConfigCommon.mk
+++ b/imx5x/BoardConfigCommon.mk
@@ -6,7 +6,11 @@ include device/fsl/imx5x/build_id.mk
 TARGET_BOARD_PLATFORM := imx5x
 TARGET_CPU_ABI := armeabi-v7a
 TARGET_CPU_ABI2 := armeabi
+TARGET_CPU_SMP := false
+TARGET_ARCH := arm
 TARGET_ARCH_VARIANT := armv7-a-neon
+ARCH_ARM_HAVE_TLS_REGISTER := true
+ARCH_ARM_USE_NON_NEON_MEMCPY := false
 
 TARGET_NO_BOOTLOADER := true
 TARGET_NO_KERNEL := false
@@ -17,7 +21,7 @@ TARGET_KERNEL_DEFCONF := imx5_android_defconfig
 TARGET_PROVIDES_INIT_RC := true
 
 #BOARD_USES_GENERIC_AUDIO := true
-#BOARD_USES_ALSA_AUDIO := true
+BOARD_USES_ALSA_AUDIO := true
 BUILD_WITH_ALSA_UTILS := true
 BOARD_HAVE_BLUETOOTH := true
 USE_CAMERA_STUB := false 
@@ -32,7 +36,8 @@ BOARD_MODEM_HAVE_DATA_DEVICE := true
 
 BOARD_HAVE_IMX_CAMERA := true
 TARGET_HAVE_IMX_GRALLOC := true
-TARGET_HAVE_IMX_HWCOMPOSER = true
+TARGET_HAVE_IMX_HWCOMPOSER := true
+USE_ION_ALLOCATOR := true
 
 HAVE_FSL_IMX_CODEC := true
 BUILD_WITHOUT_FSL_DIRECTRENDER := false
@@ -56,7 +61,10 @@ PREBUILT_FSL_IMX_GPU := true
 
 BOARD_RECOVERY_PARTITION_SIZE = 10M
 
+TARGET_USERIMAGES_USE_EXT4 := true
 INTERNAL_USERIMAGES_USE_UBIFS=true
+TARGET_USERIMAGES_SPARSE_EXT_DISABLED := true
+TARGET_PROVIDES_INIT_RC := true
 
 BOARD_SYSTEMIMAGE_PARTITION_SIZE := 209715200
 BOARD_FLASH_BLOCK_SIZE := 4096
diff --git a/imx5x/apns-conf.xml b/imx5x/apns-conf.xml
new file mode 100644
index 0000000..6a7f655
--- /dev/null
+++ b/imx5x/apns-conf.xml
@@ -0,0 +1,301 @@
+<?xml version="1.0" encoding="utf-8"?>
+<!--
+/*
+** Copyright 2006, Google Inc.
+**
+** Licensed under the Apache License, Version 2.0 (the "License");
+** you may not use this file except in compliance with the License.
+** You may obtain a copy of the License at
+**
+**     http://www.apache.org/licenses/LICENSE-2.0
+**
+** Unless required by applicable law or agreed to in writing, software
+** distributed under the License is distributed on an "AS IS" BASIS,
+** WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+** See the License for the specific language governing permissions and
+** limitations under the License.
+*/
+-->
+
+<!-- use empty string to specify no proxy or port -->
+<!-- This version must agree with that in apps/common/res/apns.xml -->
+<apns version="7">
+    <apn carrier="T-Mobile US"
+         mcc="310"
+         mnc="260"
+         apn="epc.tmobile.com"
+         user="none"
+         server="*"
+         password="none"
+         mmsc="http://mms.msg.eng.t-mobile.com/mms/wapenc"
+    />
+
+    <apn carrier="T-Mobile US 250"
+         mcc="310"
+         mnc="250"
+         apn="epc.tmobile.com"
+         user="none"
+         server="*"
+         password="none"
+         mmsc="http://mms.msg.eng.t-mobile.com/mms/wapenc"
+            />
+
+    <apn carrier="T-Mobile US 660"
+         mcc="310"
+         mnc="660"
+         apn="epc.tmobile.com"
+         user="none"
+         server="*"
+         password="none"
+         mmsc="http://mms.msg.eng.t-mobile.com/mms/wapenc"
+            />
+
+    <apn carrier="T-Mobile US 230"
+         mcc="310"
+         mnc="230"
+         apn="epc.tmobile.com"
+         user="none"
+         server="*"
+         password="none"
+         mmsc="http://mms.msg.eng.t-mobile.com/mms/wapenc"
+            />
+
+    <apn carrier="T-Mobile US 310"
+         mcc="310"
+         mnc="310"
+         apn="epc.tmobile.com"
+         user="none"
+         server="*"
+         password="none"
+         mmsc="http://mms.msg.eng.t-mobile.com/mms/wapenc"
+            />
+
+    <apn carrier="T-Mobile US 580"
+         mcc="310"
+         mnc="580"
+         apn="epc.tmobile.com"
+         user="none"
+         server="*"
+         password="none"
+         mmsc="http://mms.msg.eng.t-mobile.com/mms/wapenc"
+            />
+
+    <apn carrier="T-Mobile US 240"
+         mcc="310"
+         mnc="240"
+         apn="epc.tmobile.com"
+         user="none"
+         server="*"
+         password="none"
+         mmsc="http://mms.msg.eng.t-mobile.com/mms/wapenc"
+            />
+
+    <apn carrier="T-Mobile US 800"
+         mcc="310"
+         mnc="800"
+         apn="epc.tmobile.com"
+         user="none"
+         server="*"
+         password="none"
+         mmsc="http://mms.msg.eng.t-mobile.com/mms/wapenc"
+            />
+
+    <apn carrier="T-Mobile US 210"
+         mcc="310"
+         mnc="210"
+         apn="epc.tmobile.com"
+         user="none"
+         server="*"
+         password="none"
+         mmsc="http://mms.msg.eng.t-mobile.com/mms/wapenc"
+            />
+
+    <apn carrier="T-Mobile US 160"
+         mcc="310"
+         mnc="160"
+         apn="epc.tmobile.com"
+         user="none"
+         server="*"
+         password="none"
+         mmsc="http://mms.msg.eng.t-mobile.com/mms/wapenc"
+            />
+
+    <apn carrier="T-Mobile US 270"
+         mcc="310"
+         mnc="270"
+         apn="epc.tmobile.com"
+         user="none"
+         server="*"
+         password="none"
+         mmsc="http://mms.msg.eng.t-mobile.com/mms/wapenc"
+            />
+
+    <apn carrier="T-Mobile US 200"
+         mcc="310"
+         mnc="200"
+         apn="epc.tmobile.com"
+         user="none"
+         server="*"
+         password="none"
+         mmsc="http://mms.msg.eng.t-mobile.com/mms/wapenc"
+            />
+
+    <apn carrier="T-Mobile US 220"
+         mcc="310"
+         mnc="220"
+         apn="epc.tmobile.com"
+         user="none"
+         server="*"
+         password="none"
+         mmsc="http://mms.msg.eng.t-mobile.com/mms/wapenc"
+            />
+
+    <apn carrier="T-Mobile US 490"
+         mcc="310"
+         mnc="490"
+         apn="epc.tmobile.com"
+         user="none"
+         server="*"
+         password="none"
+         mmsc="http://mms.msg.eng.t-mobile.com/mms/wapenc"
+            />
+
+    <!-- T-Mobile Europe -->
+    <apn carrier="T-Mobile UK"
+         mcc="234"
+         mnc="30"
+         apn="general.t-mobile.uk"
+         user="t-mobile"
+         password="tm"
+         server="*"
+         mmsproxy="149.254.201.135"
+         mmsport="8080"
+         mmsc="http://mmsc.t-mobile.co.uk:8002"
+    />
+
+    <apn carrier="T-Mobile D"
+         mcc="262"
+         mnc="01"
+         apn="internet.t-mobile"
+         user="t-mobile"
+         password="tm"
+         server="*"
+         mmsproxy="172.028.023.131"
+         mmsport="8008"
+         mmsc="http://mms.t-mobile.de/servlets/mms"
+    />
+
+    <apn carrier="T-Mobile A"
+         mcc="232"
+         mnc="03"
+         apn="gprsinternet"
+         user="t-mobile"
+         password="tm"
+         server="*"
+         mmsproxy="010.012.000.020"
+         mmsport="80"
+         mmsc="http://mmsc.t-mobile.at/servlets/mms"
+         type="default,supl"
+    />
+
+    <apn carrier="T-Mobile A MMS"
+         mcc="232"
+         mnc="03"
+         apn="gprsmms"
+         user="t-mobile"
+         password="tm"
+         server="*"
+         mmsproxy="010.012.000.020"
+         mmsport="80"
+         mmsc="http://mmsc.t-mobile.at/servlets/mms"
+         type="mms"
+    />
+
+    <apn carrier="T-Mobile CZ"
+         mcc="230"
+         mnc="01"
+         apn="internet.t-mobile.cz"
+         user="wap"
+         password="wap"
+         server="*"
+         mmsproxy="010.000.000.010"
+         mmsport="80"
+         mmsc="http://mms"
+         type="default,supl"
+    />
+
+    <apn carrier="T-Mobile CZ MMS"
+         mcc="230"
+         mnc="01"
+         apn="mms.t-mobile.cz"
+         user="mms"
+         password="mms"
+         server="*"
+         mmsproxy="010.000.000.010"
+         mmsport="80"
+         mmsc="http://mms"
+         type="mms"
+    />
+
+    <apn carrier="T-Mobile NL"
+         mcc="204"
+         mnc="16"
+         apn="internet"
+         user="*"
+         password="*"
+         server="*"
+         mmsproxy="010.010.010.011"
+         mmsport="8080"
+         mmsc="http://t-mobilemms"
+         type="default,supl"
+    />
+
+    <apn carrier="T-Mobile NL MMS"
+         mcc="204"
+         mnc="16"
+         apn="mms"
+         user="tmobilemms"
+         password="tmobilemms"
+         server="*"
+         mmsproxy="010.010.010.011"
+         mmsport="8080"
+         mmsc="http://t-mobilemms"
+         type="mms"
+    />
+    <apn carrier="China Unicom 3GNET"
+         mcc="460"
+         mnc="01"
+         apn="3gnet"
+         user=""
+         server=""
+         password=""
+         mmsc=""
+    />
+    <apn carrier="China Mobile CMNET"
+         mcc="460"
+         mnc="00"
+         apn="cmnet"
+         user=""
+         server=""
+         password=""
+         mmsc=""
+    />
+    <apn carrier="China Mobile CMNET"
+         mcc="460"
+         mnc="02"
+         apn="cmnet"
+         user=""
+         server=""
+         password=""
+         mmsc=""
+    />
+    <apn carrier="China Mobile CMNET"
+         mcc="460"
+         mnc="07"
+         apn="cmnet"
+         user=""
+         server=""
+         password=""
+         mmsc=""
+    />
+</apns>
diff --git a/imx5x/build_id.mk b/imx5x/build_id.mk
index d7c683b..f2a2451 100644
--- a/imx5x/build_id.mk
+++ b/imx5x/build_id.mk
@@ -18,4 +18,4 @@
 # (like "CRB01").  It must be a single word, and is
 # capitalized by convention.
 
-export BUILD_ID=R14-Beta
+export BUILD_ID=R15-Alpha
diff --git a/imx5x/imx53_smd.mk b/imx5x/imx53_smd.mk
index 283645b..d1acd4a 100644
--- a/imx5x/imx53_smd.mk
+++ b/imx5x/imx53_smd.mk
@@ -9,8 +9,8 @@ PRODUCT_DEVICE := imx53_smd
 
 PRODUCT_COPY_FILES += \
 	device/common/gps/gps.conf_US:system/etc/gps.conf \
-	device/fsl/imx53_smd/init.rc:root/init.freescale.rc \
-	device/fsl/imx53_smd/init.usb.rc:root/init.freescale.usb.rc \
+	device/fsl/imx53_smd/fstab.freescale:root/fstab.freescale \
+	device/fsl/imx53_smd/init.freescale.rc:root/init.freescale.rc \
         device/fsl/imx53_smd/vold.fstab:system/etc/vold.fstab \
 	device/fsl/imx53_smd/gpsreset.sh:system/etc/gpsreset.sh \
 	device/fsl/common/input/eGalax_Touch_Screen.idc:system/usr/idc/eGalax_Touch_Screen.idc \
@@ -28,14 +28,18 @@ PRODUCT_COPY_FILES += \
     frameworks/native/data/etc/android.hardware.usb.host.xml:system/etc/permissions/android.hardware.usb.host.xml \
     frameworks/native/data/etc/android.hardware.usb.accessory.xml:system/etc/permissions/android.hardware.usb.accessory.xml \
     frameworks/native/data/etc/android.hardware.telephony.gsm.xml:system/etc/permissions/android.hardware.telephony.gsm.xml \
-    packages/wallpapers/LivePicker/android.software.live_wallpaper.xml:system/etc/permissions/android.software.live_wallpaper.xml \
     frameworks/native/data/etc/android.software.sip.voip.xml:system/etc/permissions/android.software.sip.voip.xml
 
-PRODUCT_AAPT_CONFIG += sw600dp
-PRODUCT_PREF_AAPT_CONFIG := sw600dp
+# for PDK build, include only when the dir exists
+# too early to use $(TARGET_BUILD_PDK)
+ifneq ($(wildcard packages/wallpapers/LivePicker),)
+PRODUCT_COPY_FILES += \
+    packages/wallpapers/LivePicker/android.software.live_wallpaper.xml:system/etc/permissions/android.software.live_wallpaper.xml
+endif
 
-DEVICE_PACKAGE_OVERLAYS := device/fsl/imx53_smd/overlay
+PRODUCT_PREF_AAPT_CONFIG := mdpi
 
-PRODUCT_TAGS += dalvik.gc.type-precise
+DEVICE_PACKAGE_OVERLAYS := device/fsl/imx53_smd/overlay
 
 PRODUCT_CHARACTERISTICS := tablet
+
diff --git a/imx5x/imx5x.mk b/imx5x/imx5x.mk
index cb1569a..671108f 100644
--- a/imx5x/imx5x.mk
+++ b/imx5x/imx5x.mk
@@ -1,10 +1,12 @@
 $(call inherit-product, $(SRC_TARGET_DIR)/product/languages_full.mk)
 $(call inherit-product, $(SRC_TARGET_DIR)/product/generic.mk)
-$(call inherit-product, frameworks/base/data/sounds/AllAudio.mk)
+$(call inherit-product, frameworks/base/data/sounds/OriginalAudio.mk)
+$(call inherit-product, frameworks/base/data/fonts/fonts.mk)
+$(call inherit-product, frameworks/base/data/keyboards/keyboards.mk)
 
 # overrides
-PRODUCT_BRAND := freescale
-PRODUCT_MANUFACTURER := freescale
+PRODUCT_BRAND := Freescale
+PRODUCT_MANUFACTURER := Freescale
 
 # Android infrastructures
 PRODUCT_PACKAGES += \
@@ -15,9 +17,9 @@ PRODUCT_PACKAGES += \
 	CubeLiveWallpapers			\
 	HoloSpiralWallpaper			\
 	Gallery2				\
-	Gallery					\
 	SoundRecorder				\
         Camera                                  \
+        LegacyCamera                            \
 	FSLOta					\
 	VideoEditor				\
 	PinyinIME				\
@@ -25,6 +27,7 @@ PRODUCT_PACKAGES += \
 	librs_jni				\
 	pppd					\
 	chat					\
+        setup_fs                                \
 	ip-up-vpn				\
 	ip-up-ppp0				\
 	ip-down-ppp0				\
@@ -33,7 +36,7 @@ PRODUCT_PACKAGES += \
 	wpa_supplicant_p2p.conf			\
 	dispd					\
 	ts_calibrator				\
-	com.android.future.usb.accessory
+	libion
 
 # Debug utils
 PRODUCT_PACKAGES += \
@@ -46,52 +49,44 @@ PRODUCT_PACKAGES += \
 # Wifi AP mode
 PRODUCT_PACKAGES += \
 	hostapd					\
-	hostapd_cli				\
-	hostapd_client          		\
-	hostapd.conf				\
-	hostapd_wps				\
-	libhostapd_client			\
-	wmiconfig				\
+	hostapd_cli
 
 # keyboard mapping files.
-PRODUCT_PACKAGES +=				\
+PRODUCT_PACKAGES += \
 	Dell_Dell_USB_Keyboard.kcm		\
 	mxckpd.kcm				\
 
 #audio related lib
-PRODUCT_PACKAGES +=		    \
-	audio.sabresd_reva.freescale 		\
-	audio.sabresd_revb.freescale 		\
-	audio.legacy.freescale 			\
-	alsa_aplay             			\
-	alsa_arecord				\
-	alsa_amixer     			\
-	alsa_ctl        			\
+PRODUCT_PACKAGES += \
+	audio.primary.imx5			\
+	audio_policy.conf			\
+	tinyplay				\
+	tinycap					\
+	tinymix					\
+	libsrec_jni				\
 	libtinyalsa 				\
 	libaudioutils
 
 # imx5x Hardware HAL libs.
-PRODUCT_PACKAGES +=				\
+PRODUCT_PACKAGES += \
 	sensors.freescale			\
 	overlay.imx5x				\
 	lights.freescale			\
 	gralloc.imx5x				\
 	copybit.imx5x				\
-	alsa.freescale				\
-	audio.primary.freescale        		\
 	hwcomposer.imx5x            		\
 	camera.imx5x            		\
 	magd
 
 # Bluetooth firmware files.
-PRODUCT_PACKAGES +=				\
+PRODUCT_PACKAGES += \
 	ar3kbdaddr.pst				\
 	PS_ASIC.pst				\
 	RamPatch.txt				\
 	audio.a2dp.default			\
 
 # Freescale VPU firmware files.
-PRODUCT_PACKAGES +=				\
+PRODUCT_PACKAGES += \
 	libvpu					\
 	vpu_fw_imx51.bin			\
 	vpu_fw_imx53.bin			\
@@ -113,9 +108,16 @@ PRODUCT_PACKAGES += \
 	artagent				\
 	ath6kl-fwlog-record			\
 	athtestcmd				\
-	athtestcmd				\
+	psatUtil				\
 	wmiconfig
-# gpu related libs. align to device/fsl/proprietary/gpu/fsl-gpu.mk
+
+# Intel PCIE wifi firmware
+PRODUCT_PACKAGES += \
+	iwlwifi-6000-4.ucode			\
+	iwlwifi-5000-5.ucode			\
+	iwlagn.ko
+
+# gpu related libs. align to device/fsl-proprietary/gpu/fsl-gpu.mk
 PRODUCT_PACKAGES += \
 	libEGL_imx51.so				\
 	libGLESv1_CM_imx51.so			\
@@ -140,10 +142,10 @@ PRODUCT_PACKAGES += \
 	libdrmframework_jni			\
 	libdrmframework				\
 	libdrmpassthruplugin			\
-	libfwdlockengine			\
+	libfwdlockengine
 
 # Omx related libs, please align to device/fsl/proprietary/omx/fsl-omx.mk
-omx_libs :=						\
+omx_libs := \
 	core_register					\
 	component_register				\
 	contentpipe_register				\
@@ -179,9 +181,6 @@ omx_libs :=						\
 	lib_omx_android_audio_render_arm11_elinux	\
 	lib_omx_audio_fake_render_arm11_elinux		\
 	lib_omx_ipulib_render_arm11_elinux		\
-	lib_omx_surface_render_arm11_elinux		\
-	lib_omx_https_pipe_v2_arm11_elinux		\
-	lib_omx_streaming_parser_arm11_elinux		\
 	lib_avi_parser_arm11_elinux.3.0			\
 	lib_divx_drm_arm11_elinux			\
 	lib_mp4_parser_arm11_elinux.3.0			\
@@ -196,7 +195,6 @@ omx_libs :=						\
 	lib_aac_dec_v2_arm12_elinux			\
 	lib_flac_dec_v2_arm11_elinux			\
 	lib_nb_amr_dec_v2_arm9_elinux			\
-	lib_wb_amr_dec_arm9_elinux			\
 	lib_oggvorbis_dec_v2_arm11_elinux		\
 	lib_peq_v2_arm11_elinux				\
 	lib_mpg2_parser_arm11_elinux.3.0		\
@@ -210,21 +208,26 @@ omx_libs :=						\
 	lib_omx_overlay_render_arm11_elinux		\
 	lib_omx_fsl_muxer_v2_arm11_elinux		\
 	lib_omx_mp3_enc_v2_arm11_elinux			\
-	lib_omx_aac_enc_v2_arm11_elinux			\
 	lib_omx_amr_enc_v2_arm11_elinux			\
 	lib_omx_android_audio_source_arm11_elinux	\
 	lib_omx_camera_source_arm11_elinux		\
 	lib_mp4_muxer_arm11_elinux			\
 	lib_mp3_enc_v2_arm12_elinux			\
 	lib_nb_amr_enc_v2_arm11_elinux			\
-	lib_wb_amr_enc_arm11_elinux			\
 	lib_omx_vpu_enc_v2_arm11_elinux			\
 	lib_ffmpeg_arm11_elinux				\
+	lib_omx_https_pipe_v2_arm11_elinux		\
+	lib_omx_streaming_parser_arm11_elinux		\
+	lib_omx_surface_render_arm11_elinux		\
+	libfsl_jpeg_enc_arm11_elinux			\
+	lib_wb_amr_enc_arm11_elinux			\
+	lib_wb_amr_dec_arm9_elinux			\
+	lib_omx_aac_enc_v2_arm11_elinux
 
 # Omx excluded libs
 omx_excluded_libs :=					\
 	lib_asf_parser_arm11_elinux.3.0			\
-	lib_wma10_dec_v2_arm12_elinux		\
+	lib_wma10_dec_v2_arm12_elinux			\
 	lib_WMV789_dec_v2_arm11_elinux.so		\
 	lib_aacplus_dec_v2_arm11_elinux			\
 	lib_ac3_dec_v2_arm11_elinux			\
@@ -237,19 +240,28 @@ PRODUCT_PACKAGES += $(omx_libs) $(omx_excluded_libs)
 
 PRODUCT_PACKAGES += libubi ubinize ubiformat ubiattach ubidetach ubiupdatevol ubimkvol ubinfo mkfs.ubifs
 
+# for CtsVerifier
+PRODUCT_PACKAGES += \
+    com.android.future.usb.accessory
+
 PRODUCT_AAPT_CONFIG := normal mdpi
 
 PRODUCT_COPY_FILES +=	\
 	device/fsl/common/input/Dell_Dell_USB_Keyboard.kl:system/usr/keylayout/Dell_Dell_USB_Keyboard.kl \
 	device/fsl/common/input/Dell_Dell_USB_Keyboard.idc:system/usr/idc/Dell_Dell_USB_Keyboard.idc \
 	device/fsl/imx5x/init.rc:root/init.rc \
-	device/fsl/imx5x/initlogo.rle:root/initlogo.rle \
-	external/linux-firmware-imx/firmware/vpu/vpu_fw_imx53.bin:system/lib/firmware/vpu/vpu_fw_imx53.bin
+	device/fsl/imx5x/apns-conf.xml:system/etc/apns-conf.xml \
+	device/fsl/imx5x/init.freescale.usb.rc:root/init.freescale.usb.rc \
+	device/fsl/imx5x/ueventd.freescale.rc:root/ueventd.freescale.rc \
+	device/fsl/imx5x/init.gprs-pppd:system/etc/ppp/init.gprs-pppd \
+	device/fsl/imx5x/initlogo.rle:root/initlogo.rle
 
-# for all other directory
+# VPU firmware
 PRODUCT_COPY_FILES +=	\
-	device/fsl/imx5x/ueventd.freescale.rc:root/ueventd.freescale.rc \
-	device/fsl/imx5x/init.gprs-pppd:system/etc/ppp/init.gprs-pppd
+	external/linux-firmware-imx/firmware/vpu/vpu_fw_imx53.bin:system/lib/firmware/vpu/vpu_fw_imx53.bin
+
+PRODUCT_TAGS += dalvik.gc.type-precise
+
 
 # for property
 PRODUCT_DEFAULT_PROPERTY_OVERRIDES := \
@@ -258,4 +270,3 @@ PRODUCT_DEFAULT_PROPERTY_OVERRIDES := \
 # include a google recommand heap config file.
 include frameworks/native/build/tablet-dalvik-heap.mk
 
-BOARD_SYSTEMIMAGE_PARTITION_SIZE := 155189248
diff --git a/imx5x/init.freescale.usb.rc b/imx5x/init.freescale.usb.rc
new file mode 100644
index 0000000..1e331de
--- /dev/null
+++ b/imx5x/init.freescale.usb.rc
@@ -0,0 +1,74 @@
+# USB massstorage configuration, with adb
+on property:sys.usb.config=mass_storage,adb
+    write /sys/class/android_usb/android0/enable 0
+    write /sys/class/android_usb/android0/idVendor 18d1
+    write /sys/class/android_usb/android0/idProduct d02
+    write /sys/class/android_usb/android0/functions ${sys.usb.config}
+    write /sys/class/android_usb/android0/enable 1
+    start adbd
+    setprop sys.usb.state ${sys.usb.config}
+
+# USB massstorage configuration
+on property:sys.usb.config=mass_storage
+    write /sys/class/android_usb/android0/enable 0
+    write /sys/class/android_usb/android0/idVendor 18d1
+    write /sys/class/android_usb/android0/idProduct 2d01
+    write /sys/class/android_usb/android0/functions ${sys.usb.config}
+    write /sys/class/android_usb/android0/enable 1
+    setprop sys.usb.state ${sys.usb.config}
+
+# USB rndis configuration
+on property:sys.usb.config=rndis
+    write /sys/class/android_usb/android0/enable 0
+    write /sys/class/android_usb/android0/idVendor 18d1
+    write /sys/class/android_usb/android0/idProduct 4e23
+    write /sys/class/android_usb/android0/functions ${sys.usb.config}
+    write /sys/class/android_usb/android0/bDeviceClass 224
+    write /sys/class/android_usb/android0/enable 1
+    setprop sys.usb.state ${sys.usb.config}
+
+# USB rndis configuration with adb
+on property:sys.usb.config=rndis,adb
+    write /sys/class/android_usb/android0/enable 0
+    write /sys/class/android_usb/android0/idVendor 18d1
+    write /sys/class/android_usb/android0/idProduct 4e24
+    write /sys/class/android_usb/android0/functions ${sys.usb.config}
+    write /sys/class/android_usb/android0/bDeviceClass 224
+    write /sys/class/android_usb/android0/enable 1
+    start adbd
+    setprop sys.usb.state ${sys.usb.config}
+
+on property:sys.usb.config=mtp
+    write /sys/class/android_usb/android0/enable 0
+    write /sys/class/android_usb/android0/idVendor 18d1
+    write /sys/class/android_usb/android0/idProduct 2d02
+    write /sys/class/android_usb/android0/functions ${sys.usb.config}
+    write /sys/class/android_usb/android0/enable 1
+    setprop sys.usb.state ${sys.usb.config}
+
+on property:sys.usb.config=mtp,adb
+    write /sys/class/android_usb/android0/enable 0
+    write /sys/class/android_usb/android0/idVendor 18d1
+    write /sys/class/android_usb/android0/idProduct d02
+    write /sys/class/android_usb/android0/functions ${sys.usb.config}
+    write /sys/class/android_usb/android0/enable 1
+    start adbd
+    setprop sys.usb.state ${sys.usb.config}
+
+on property:sys.usb.config=ptp
+    write /sys/class/android_usb/android0/enable 0
+    write /sys/class/android_usb/android0/idVendor 18d1
+    write /sys/class/android_usb/android0/idProduct 2d03
+    write /sys/class/android_usb/android0/functions ${sys.usb.config}
+    write /sys/class/android_usb/android0/enable 1
+    setprop sys.usb.state ${sys.usb.config}
+
+on property:sys.usb.config=ptp,adb
+    write /sys/class/android_usb/android0/enable 0
+    write /sys/class/android_usb/android0/idVendor 18d1
+    write /sys/class/android_usb/android0/idProduct d02
+    write /sys/class/android_usb/android0/functions ${sys.usb.config}
+    write /sys/class/android_usb/android0/enable 1
+    start adbd
+    setprop sys.usb.state ${sys.usb.config}
+
diff --git a/imx5x/init.rc b/imx5x/init.rc
index 3294818..7d09d0c 100644
--- a/imx5x/init.rc
+++ b/imx5x/init.rc
@@ -32,10 +32,11 @@ loglevel 3
     export ANDROID_DATA /data
     export ASEC_MOUNTPOINT /mnt/asec
     export LOOP_MOUNTPOINT /mnt/obb
-    export BOOTCLASSPATH /system/framework/core.jar:/system/framework/core-junit.jar:/system/framework/bouncycastle.jar:/system/framework/ext.jar:/system/framework/framework.jar:/system/framework/android.policy.jar:/system/framework/services.jar:/system/framework/apache-xml.jar
     export SHM_MOUNTPOINT /mnt/shm
     export EXTERNAL_STORAGE /mnt/sdcard
     export SECONDARY_STORAGE /mnt/extsd:/mnt/udisk
+    export BOOTCLASSPATH /system/framework/core.jar:/system/framework/core-junit.jar:/system/framework/bouncycastle.jar:/system/framework/ext.jar:/system/framework/framework.jar:/system/framework/android.policy.jar:/system/framework/services.jar:/system/framework/apache-xml.jar
+
     export LIGHTSENSOR_PATH /sys/class/i2c-adapter/i2c-1/1-0044
     export VPU_FW_PATH /system/lib/firmware/vpu
     export CODEC_SHM_PATH /mnt/shm
@@ -50,7 +51,7 @@ loglevel 3
 
 # Right now vendor lives on the same filesystem as system,
 # but someday that may change.
-    mkdir /device 0771 system system
+    symlink /system/vendor /vendor
 
 # Create cgroup mount point for cpu accounting
     mkdir /acct
@@ -67,6 +68,7 @@ loglevel 3
     mkdir /data 0771 system system
     mkdir /cache 0770 system cache
     mkdir /config 0500 root root
+    mkdir /device 0771 system system
 
     # Directory for putting things only root should see.
     mkdir /mnt/secure 0700 root root
@@ -89,6 +91,7 @@ loglevel 3
     # shared memory used by middleware
     mkdir /mnt/shm 0775 system graphics
     mount tmpfs tmpfs /mnt/shm mode=0775,uid=1000,gid=1003,size=1m
+
     write /proc/sys/kernel/panic_on_oops 1
     write /proc/sys/kernel/hung_task_timeout_secs 0
     write /proc/cpu/alignment 4
@@ -135,6 +138,7 @@ loglevel 3
 on post-fs
     # once everything is setup, no need to modify /
     mount rootfs rootfs / ro remount
+
     # We chown/chmod /cache again so because mount is run as root + defaults
     chown system cache /cache
     chmod 0770 /cache
@@ -200,7 +204,6 @@ on post-fs-data
     mkdir /data/app-private 0771 system system
     mkdir /data/app-asec 0700 root root
     mkdir /data/app 0771 system system
-    mkdir /data/app/ing 0771 root root
     mkdir /data/property 0700 root root
     mkdir /data/ssh 0750 root shell
     mkdir /data/ssh/empty 0700 root root
@@ -229,11 +232,6 @@ on post-fs-data
     # Set indication (checked by vold) that we have finished this action
     #setprop vold.post_fs_data_done 1
 
-    chown system system /sys/class/android_usb/android0/f_mass_storage/lun/file
-    chmod 0660 /sys/class/android_usb/android0/f_mass_storage/lun/file
-    chown system system /sys/class/android_usb/android0/f_rndis/ethaddr
-    chmod 0660 /sys/class/android_usb/android0/f_rndis/ethaddr
-
 on boot
 # basic network init
     ifup lo
@@ -245,8 +243,7 @@ on boot
 
 # Memory management.  Basic kernel parameters, and allow the high
 # level system server to be able to adjust the kernel OOM driver
-# paramters to match how it is managing things.
-
+# parameters to match how it is managing things.
     write /proc/sys/vm/overcommit_memory 1
     write /proc/sys/vm/min_free_order_shift 4
     chown root system /sys/module/lowmemorykiller/parameters/adj
@@ -271,27 +268,6 @@ on boot
     chmod 0660 /sys/power/state
     chmod 0660 /sys/power/wake_lock
     chmod 0660 /sys/power/wake_unlock
-
-    chown system system /sys/devices/system/cpu/cpufreq/interactive/timer_rate
-    chmod 0660 /sys/devices/system/cpu/cpufreq/interactive/timer_rate
-    chown system system /sys/devices/system/cpu/cpufreq/interactive/min_sample_time
-    chmod 0660 /sys/devices/system/cpu/cpufreq/interactive/min_sample_time
-    chown system system /sys/devices/system/cpu/cpufreq/interactive/hispeed_freq
-    chmod 0660 /sys/devices/system/cpu/cpufreq/interactive/hispeed_freq
-    chown system system /sys/devices/system/cpu/cpufreq/interactive/go_hispeed_load
-    chmod 0660 /sys/devices/system/cpu/cpufreq/interactive/go_hispeed_load
-    chown system system /sys/devices/system/cpu/cpufreq/interactive/above_hispeed_delay
-    chmod 0660 /sys/devices/system/cpu/cpufreq/interactive/above_hispeed_delay
-    chown system system /sys/devices/system/cpu/cpufreq/interactive/boost
-    chmod 0660 /sys/devices/system/cpu/cpufreq/interactive/boost
-    chown system system /sys/devices/system/cpu/cpufreq/interactive/boostpulse
-    chown system system /sys/devices/system/cpu/cpufreq/interactive/input_boost
-    chmod 0660 /sys/devices/system/cpu/cpufreq/interactive/input_boost
-
-    # Assume SMP uses shared cpufreq policy for all CPUs
-    chown system system /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq
-    chmod 0660 /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq
-
     chown system system /sys/class/timed_output/vibrator/enable
     chown system system /sys/class/leds/keyboard-backlight/brightness
     chown system system /sys/class/leds/lcd-backlight/brightness
@@ -382,6 +358,10 @@ on boot
 # mount the debugfs
     mount debugfs none /sys/kernel/debug/
 
+# Prepare for RIL
+    setprop gsm.ril.delay 15
+    setprop ro.ril.wake_lock_timeout 300
+
 # Set this property so surfaceflinger is not started by system_init
     setprop system_init.startsurfaceflinger 0
 
@@ -462,12 +442,13 @@ service netd /system/bin/netd
 service debuggerd /system/bin/debuggerd
     class main
 
-service ril-daemon /system/bin/rild
+service ril-daemon /system/bin/rild -l /system/lib/libreference-ril.so
     class main
     socket rild stream 660 root radio
     socket rild-debug stream 660 radio system
+    socket rild-ppp stream 660 radio system
     user root
-    group radio cache inet misc audio sdcard_rw log
+    group radio cache inet misc audio sdcard_r sdcard_rw log
 
 service surfaceflinger /system/bin/surfaceflinger
     class main
@@ -552,24 +533,12 @@ service dumpstate /system/bin/dumpstate -s
     disabled
     oneshot
 
-service sshd /system/bin/start-ssh
-    class main
-    disabled
-
-service mdnsd /system/bin/mdnsd
-    class main
-    user mdnsr
-    group inet net_raw
-    socket mdnsd stream 0660 mdnsr inet
-    disabled
-    oneshot
-
 service dhcpcd_wlan0 /system/bin/dhcpcd -ABKL
     class late_start
     disabled
     oneshot
 
-service dhcpcd_eth0 /system/bin/dhcpcd -ABKL
+service dhcpcd_eth0 /system/bin/dhcpcd -AL
     class late_start
     disabled
     oneshot
@@ -581,27 +550,25 @@ service hostapd /system/bin/hostapd /data/misc/wifi/hostapd.conf
     oneshot
     disabled
 
-service ril-daemon /system/bin/rild -l /system/lib/libreference-ril.so
-    class main
-    socket rild stream 660 root radio
-    socket rild-debug stream 660 radio system
-    socket rild-ppp stream 660 radio system
-    user root
-    group radio cache inet misc audio
-
-service pppd_gprs /etc/ppp/init.gprs-pppd
+service pppd_gprs /etc/init.gprs-pppd
     class main
     user root
     group radio cache inet misc
     disabled
     oneshot
 
-service gpu_init /system/bin/gpu_init.sh
-    class core
-    user root
-    group root
-    oneshot
-
 service wifi_mac /system/bin/sh /system/etc/check_wifi_mac.sh
     class late_start
     oneshot
+
+service sshd /system/bin/start-ssh
+    class main
+    disabled
+
+service mdnsd /system/bin/mdnsd
+    class main
+    user mdnsr
+    group inet net_raw
+    socket mdnsd stream 0660 mdnsr inet
+    disabled
+    oneshot
diff --git a/imx5x/ueventd.freescale.rc b/imx5x/ueventd.freescale.rc
index 96d0a09..b5f0771 100644
--- a/imx5x/ueventd.freescale.rc
+++ b/imx5x/ueventd.freescale.rc
@@ -1,25 +1,25 @@
 /dev/ttymxc1              0600   bluetooth  bluetooth
 /dev/ttymxc2              0600   bluetooth  bluetooth
-/dev/pmem_gpu             0660   system     graphics
-/dev/pmem_adsp            0666   system     audio
+/dev/ion                  0666   media      system
 /dev/snd/*                0664   system     audio
 /dev/ttyUSB*              0640   radio      radio
 /dev/ttyACM*              0640   radio      radio
 /dev/video0               0660   system     camera
 /dev/video1               0660   system     camera
 /dev/video16              0660   system     graphics
-/dev/mxc_ipu              0666   system     graphics
+/dev/mxc_ipu              0660   graphics   system
 /dev/mxc_iim              0664   system     media
 /dev/mxs_viim             0664   system     media
 /dev/fsl_cache            0666   system     graphics
 /dev/gsl_kmod             0666   system     graphics
-/dev/mxc_vpu              0666   system     media
+/dev/mxc_vpu              0660   media      system
 /dev/uinput               0666   system     input
-/dev/ttymxc1              0775   system     gps
-/dev/ttya0                0775   system     gps
-/dev/ptya0                0775   system     gps
-/dev/ttya1                0775   system     gps
-/dev/ptya1                0775   system     gps
+/dev/ttymxc1              0660   system     gps
+/dev/ttya0                0660   system     gps
+/dev/ptya0                0660   system     gps
+/dev/ttya1                0660   system     gps
+/dev/ptya1                0660   system     gps
+/dev/graphics/fb0         0660   system     graphics
 
 # sysfs properties
 /sys/devices/virtual/input/input*   name        0660  root   input
-- 
1.8.0

